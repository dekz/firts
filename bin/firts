#!/usr/bin/env ruby
require 'thor'
$:.unshift File.expand_path(File.join(File.dirname(__FILE__), '../lib'))
require 'firts'

class FirtsApp < Thor
  map '-v' => 'version'
  map '--version' => 'version'

  desc 'worker [CONFIG]', 'Start a simple worker'
  method_option :ts, :type => :string, :aliases => '-t', :desc => 'TupleSpace location'
  method_option :num, :type => :numeric, :aliases => '-n', :desc => 'Number of workers'
  def worker(config={})
    opts = options.dup
    opts[:server] = options[:ts] if options[:ts]
    opts[:worker_count] = options[:num] if options[:num]
    runner = WorkerRunner.new opts
    runner.run
  end

  desc 'taskmaster [CONFIG]', 'Start a taskmaster'
  method_option :ts, :type => :string, :aliases => '-t', :desc => 'TupleSpace location'
  def taskmaster(config={})
    require 'irb'
    opts = options.dup
    opts[:server] = options[:ts] if options[:ts]
    $tm = Taskmaster.new opts
    ARGV.clear
    ::IRB.start
  end

  desc 'watcher', 'Start a watcher'
  method_option :ts, :type => :string, :aliases => '-t', :desc => 'TupleSpace location'
  def watcher(config={})
    opts = options.dup
    opts[:server] = options[:ts] if options[:ts]
    watcher = Watcher.new opts
    watcher.watch
  end

  desc 'ts [CONFIG]', 'Start a TupleSpace'
  method_option :ts, :type => :string, :aliases => '-t', :desc => 'TupleSpace location'
  def ts(config={})
    ts = TupleServer.new options[:ts]
  end
end

FirtsApp.start
