#!/usr/bin/env ruby
require 'thor'
$:.unshift File.expand_path(File.join(File.dirname(__FILE__), '../lib'))
require 'firts'

class FirtsApp < Thor
  map '-v' => 'version'
  map '--version' => 'version'

  desc 'worker [CONFIG]', 'Start a simple worker'
  method_option :ts, :type => :string, :aliases => '-t', :desc => 'TupleSpace location'
  method_option :num, :type => :numeric, :aliases => '-n', :desc => 'Number of workers'
  method_option :num_wr, :type => :numeric, :aliases => '-n', :desc => 'Number of worker runners'
  method_option :daemonize, :type => :string, :aliases => '-d', :desc => 'Daemonize the worker runners'
  def worker(name=nil)
    opts = options.dup
    opts[:server] = options[:ts] if options[:ts]
    opts[:worker_count] = options[:num] || 1
    opts[:worker_runners] = options[:num_wr] || 1
    opts[:name] = name unless name.nil?
    if opts[:daemonize]
      # FORK DAEMONIZE
      opts[:worker_runners].times do |i|
        fork do
          begin
            runner = Firts::WorkerRunner.new opts
            runner.run
          rescue Interrupt
            runner.cleanup
          end
        end
      end
    else
      # THREADED RUN
      threads = []
      worker_runners = []
      opts[:worker_runners].times do |i|
        threads << Thread.new do
          runner = Firts::WorkerRunner.new opts
          worker_runners << runner
          runner.run
        end
      end

      begin
        threads.each { |t| t.join }
      rescue Interrupt
        worker_runners.each { |w| w.cleanup }
      end
    end
  end

  desc 'taskmaster [CONFIG]', 'Start a taskmaster'
  method_option :ts, :type => :string, :aliases => '-t', :desc => 'TupleSpace location'
  def taskmaster(config={})
    require 'irb'
    opts = options.dup
    opts[:server] = options[:ts] if options[:ts]
    $tm = Taskmaster.new opts
    ARGV.clear
    ::IRB.start
  end

  desc 'watcher', 'Start a watcher'
  method_option :ts, :type => :string, :aliases => '-t', :desc => 'TupleSpace location'
  def watcher(config={})
    opts = options.dup
    opts[:server] = options[:ts] if options[:ts]
    watcher = Watcher.new opts
    watcher.watch
  end

  desc 'ts [CONFIG]', 'Start a TupleSpace'
  method_option :ts, :type => :string, :aliases => '-t', :desc => 'TupleSpace location'
  def ts(config={})
    ts = TupleServer.new options
  end
end

FirtsApp.start
